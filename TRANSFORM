//oprava duplikátov
SELECT 
    ad_date, 
    AD_ID, 
    COUNT(*) as dup_count
FROM RAW.STG_FB_ADS_INSIGHTS
GROUP BY ad_date, AD_ID
HAVING COUNT(*) > 1;

//deduplikácia - spájanie rovankých riadkov
CREATE OR REPLACE TABLE RAW.STG_FB_ADS_DEDUPLICATED AS
SELECT
    ad_date,
    ACCOUNT_ID,
    ACCOUNT_NAME,
    CAMPAIGN_ID,
    CAMPAIGN_NAME,
    ADSET_ID,
    ADSET_NAME,
    AD_ID,
    AD_NAME,
    OBJECTIVE,
    ROUND(AVG(IMPRESSIONS)) AS IMPRESSIONS,
    ROUND(AVG(CLICKS)) AS CLICKS,
    ROUND(AVG(SPEND), 2) AS SPEND,
    ROUND(AVG(REACH)) AS REACH,
    ROUND(AVG(FREQUENCY), 4) AS FREQUENCY,
    ROUND(AVG(CTR), 4) AS CTR,
    ROUND(AVG(CPM), 2) AS CPM,
    ROUND(AVG(CPC), 4) AS CPC,
    platform,
    MAX(load_timestamp) AS load_timestamp
FROM RAW.STG_FB_ADS_INSIGHTS
GROUP BY 
    ad_date, ACCOUNT_ID, ACCOUNT_NAME, CAMPAIGN_ID, CAMPAIGN_NAME,
    ADSET_ID, ADSET_NAME, AD_ID, AD_NAME, OBJECTIVE, platform;

//Validácia deduplikácie
SELECT COUNT(*) FROM RAW.STG_FB_ADS_DEDUPLICATED;

//anomálie
SELECT 
    ad_date, 
    CAMPAIGN_NAME, 
    CPC, 
    CPM, 
    SPEND,
    IMPRESSIONS
FROM RAW.STG_FB_ADS_DEDUPLICATED
WHERE CPC > 100 OR CPM > 50 OR CPC < 0.001
ORDER BY CPC DESC;
