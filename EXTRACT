//nastavenie
USE ROLE TRAINING_ROLE;
USE WAREHOUSE LYNX_WH;
USE DATABASE LR_PROJECT_DB;
CREATE SCHEMA IF NOT EXISTS RAW;
CREATE SCHEMA IF NOT EXISTS ANALYTICS;


//EXTRACT//

//overenie dostuponosti
SHOW DATABASES;
SELECT COUNT(*) FROM AD_DATA_FUSION.FACEBOOK_ADS.ADS_INSIGHTS;

//štruktúra dát
SELECT * 
FROM AD_DATA_FUSION.FACEBOOK_ADS.ADS_INSIGHTS
LIMIT 5;

//načítanie dát
CREATE OR REPLACE TABLE RAW.STG_FB_ADS_INSIGHTS AS
SELECT
    CAST(DATE_START AS DATE) AS ad_date,
    ACCOUNT_ID,
    ACCOUNT_NAME,
    CAMPAIGN_ID,
    CAMPAIGN_NAME,
    ADSET_ID,
    ADSET_NAME,
    AD_ID,
    AD_NAME,
    OBJECTIVE,
    CAST(IMPRESSIONS AS NUMBER(38,0)) AS IMPRESSIONS,
    CAST(CLICKS AS NUMBER(38,0)) AS CLICKS,
    CAST(SPEND AS NUMBER(38,2)) AS SPEND,
    CAST(REACH AS NUMBER(38,0)) AS REACH,
    CAST(FREQUENCY AS FLOAT) AS FREQUENCY,
    CAST(CTR AS FLOAT) AS CTR,
    CAST(CPM AS FLOAT) AS CPM,
    CAST(CPC AS FLOAT) AS CPC,
    'FACEBOOK' AS platform,
    CURRENT_TIMESTAMP() AS load_timestamp
FROM AD_DATA_FUSION.FACEBOOK_ADS.ADS_INSIGHTS
WHERE 
    DATE_START IS NOT NULL 
    AND IMPRESSIONS > 0
    AND ACCOUNT_ID IS NOT NULL;

//validácia dát
SELECT COUNT(*) AS total_records FROM RAW.STG_FB_ADS_INSIGHTS;
SELECT MIN(ad_date) AS earliest, MAX(ad_date) AS latest FROM RAW.STG_FB_ADS_INSIGHTS;

//TRANSFORM//

//oprava duplikátov
SELECT 
    ad_date, 
    AD_ID, 
    COUNT(*) as dup_count
FROM RAW.STG_FB_ADS_INSIGHTS
GROUP BY ad_date, AD_ID
HAVING COUNT(*) > 1;

//deduplikácia - spájanie rovankých riadkov
CREATE OR REPLACE TABLE RAW.STG_FB_ADS_DEDUPLICATED AS
SELECT
    ad_date,
    ACCOUNT_ID,
    ACCOUNT_NAME,
    CAMPAIGN_ID,
    CAMPAIGN_NAME,
    ADSET_ID,
    ADSET_NAME,
    AD_ID,
    AD_NAME,
    OBJECTIVE,
    ROUND(AVG(IMPRESSIONS)) AS IMPRESSIONS,
    ROUND(AVG(CLICKS)) AS CLICKS,
    ROUND(AVG(SPEND), 2) AS SPEND,
    ROUND(AVG(REACH)) AS REACH,
    ROUND(AVG(FREQUENCY), 4) AS FREQUENCY,
    ROUND(AVG(CTR), 4) AS CTR,
    ROUND(AVG(CPM), 2) AS CPM,
    ROUND(AVG(CPC), 4) AS CPC,
    platform,
    MAX(load_timestamp) AS load_timestamp
FROM RAW.STG_FB_ADS_INSIGHTS
GROUP BY 
    ad_date, ACCOUNT_ID, ACCOUNT_NAME, CAMPAIGN_ID, CAMPAIGN_NAME,
    ADSET_ID, ADSET_NAME, AD_ID, AD_NAME, OBJECTIVE, platform;

//Validácia deduplikácie
SELECT COUNT(*) FROM RAW.STG_FB_ADS_DEDUPLICATED;

//anomálie
SELECT 
    ad_date, 
    CAMPAIGN_NAME, 
    CPC, 
    CPM, 
    SPEND,
    IMPRESSIONS
FROM RAW.STG_FB_ADS_DEDUPLICATED
WHERE CPC > 100 OR CPM > 50 OR CPC < 0.001
ORDER BY CPC DESC;
