//nastavenie
USE ROLE TRAINING_ROLE;
USE WAREHOUSE LYNX_WH;
USE DATABASE LR_PROJECT_DB;
CREATE SCHEMA IF NOT EXISTS RAW;
CREATE SCHEMA IF NOT EXISTS ANALYTICS;


//EXTRACT//

//overenie dostuponosti
SHOW DATABASES;
SELECT COUNT(*) FROM AD_DATA_FUSION.FACEBOOK_ADS.ADS_INSIGHTS;

//štruktúra dát
SELECT * 
FROM AD_DATA_FUSION.FACEBOOK_ADS.ADS_INSIGHTS
LIMIT 5;

//načítanie dát
CREATE OR REPLACE TABLE RAW.STG_FB_ADS_INSIGHTS AS
SELECT
    CAST(DATE_START AS DATE) AS ad_date,
    ACCOUNT_ID,
    ACCOUNT_NAME,
    CAMPAIGN_ID,
    CAMPAIGN_NAME,
    ADSET_ID,
    ADSET_NAME,
    AD_ID,
    AD_NAME,
    OBJECTIVE,
    CAST(IMPRESSIONS AS NUMBER(38,0)) AS IMPRESSIONS,
    CAST(CLICKS AS NUMBER(38,0)) AS CLICKS,
    CAST(SPEND AS NUMBER(38,2)) AS SPEND,
    CAST(REACH AS NUMBER(38,0)) AS REACH,
    CAST(FREQUENCY AS FLOAT) AS FREQUENCY,
    CAST(CTR AS FLOAT) AS CTR,
    CAST(CPM AS FLOAT) AS CPM,
    CAST(CPC AS FLOAT) AS CPC,
    'FACEBOOK' AS platform,
    CURRENT_TIMESTAMP() AS load_timestamp
FROM AD_DATA_FUSION.FACEBOOK_ADS.ADS_INSIGHTS
WHERE 
    DATE_START IS NOT NULL 
    AND IMPRESSIONS > 0
    AND ACCOUNT_ID IS NOT NULL;

//validácia dát
SELECT COUNT(*) AS total_records FROM RAW.STG_FB_ADS_INSIGHTS;
SELECT MIN(ad_date) AS earliest, MAX(ad_date) AS latest FROM RAW.STG_FB_ADS_INSIGHTS;
